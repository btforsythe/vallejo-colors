<!DOCTYPE html>
<html>
<head>
	<title>Proximity Calculator</title>

	<style>
		.colorDisplay {
			padding: 0.35rem 0.7rem;
			border: solid 0.05rem black;
			margin: 0 0.2rem;
		}
	</style>
</head>
<body>
	<label for="rgb">RGB:</label>
	<input type="text" id="rgb" />
	<span class="colorDisplay"></span>
	<label for="setSelector">Set:</label>
	<select id="setSelector"></select>
	<button id="find">Find!</button>

	<script src="./js/color.js"></script>
	<script src="./js/product.js"></script>
	<script src="./js/product-matcher.js"></script>
	<script src="./js/color-set.js"></script>
	<script src="./setsData.js"></script>

	<table>
		<thead>
			<tr>
				<th>Color</th>
				<th>Model</th>
				<th colspan="2">Similarity</th>
			</tr>
		</thead>
		<tbody class="matches"></tbody>
	</table>
	<script>
		window.onload = function() {
			populateSetSelector()
			wireColorDisplayUpdate()
			wireFindButton()
		}

		let populateSetSelector = function() {
			let selector = setSelector()
			sets.map(createSetOption).forEach(o => selector.appendChild(o))
		}

		let setSelector = () => document.getElementById('setSelector')

		let createSetOption = function(set) {
			let option = document.createElement('option')
			option.textContent = set.name
			return option
		}

		let wireColorDisplayUpdate = function() {
			rgbInput().onchange = () => {
				let selectedColor = colorToMatch()
				colorDisplay().style.backgroundColor =
					`rgb(${selectedColor.blue}, ${selectedColor.green},
					${selectedColor.blue})`
			}
		}

		let rgbInput = () => document.getElementById('rgb')
		let colorDisplay = () => document.querySelector('#rgb + .colorDisplay')

		let colorToMatch = () => Color.fromRgb(rgbInput().value)

		let wireFindButton = function() {
			let find = document.getElementById('find')
			find.onclick = findSetMatches
		}

		let findSetMatches = function() {

			// TODO extract this code to products matcher that uses ColorMatcher
			let matchedColors = new ProductMatcher(selectedSet()).match(colorToMatch())

			let matches = new Map()
			matchedColors.forEach((proximity, color) => {

				let product = selectedSet().findProductByModelNumber(color.model)

				matches.set(product, proximity)
			})

			clearMatchTableRows()
			matches.forEach(addMatchTableRow)
		}

		let clearMatchTableRows = () => matchesTableBody().innerHTML = ''

		let matchesTableBody = () => document.querySelector('.matches')

		let addMatchTableRow = (similarity, product) => {

			let row = document.createElement('tr')
			matchesTableBody().appendChild(row)

			row.appendChild(buildTd(product.name))
			row.appendChild(buildTd(product.model))
			row.appendChild(buildTd(similarity))
			row.appendChild(buildColorCell(product))
		}

		let buildTd = (content) => {
			let td = document.createElement('td')
			td.textContent = content
			return td
		}

		let buildColorCell = (product) => {
			let td = document.createElement('td')
			td.className = 'colorDisplay'
			td.style.backgroundColor = product.rgb
			return td
		}

		let selectedSet = () => findSetNamed(selectedSetName())
		let findSetNamed = function(name) {
			return sets.find(s => s.name === name)
		}
		let selectedSetName = () => setSelector().selectedOptions[0].value

	</script>
</body>
</html>